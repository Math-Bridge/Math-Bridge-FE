when:
  - event: pull_request
    branch: main
  - event: push
    branch: main
    
steps:
  - name: Building FE
    image: bash
    environment:
      VITE_GEMINI_API_KEY:
        from_secret: GEMINI_API_KEY
    commands:
      - apt-get update && apt-get install -y libatomic1
      - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
      - export NVM_DIR="$HOME/.nvm"
      - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
      - '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"'
      - nvm install node
      - nvm use node
      - corepack enable pnpm
      - pnpm install --no-frozen-lockfile
      - pnpm build

  - name: Deploy FE
    image: bash
    environment:
      SSHK:
        from_secret: SSH_KEY
      REMOTE_HOST: 192.168.2.245
      REMOTE_USER: root
      REMOTE_TARGET_PATH: /root
    commands:
      - apt-get update -y && apt-get install -y openssh-client rsync

      # Setup SSH
      - mkdir -p $HOME/.ssh
      - echo "$SSHK" > $HOME/.ssh/id_rsa_deploy
      - chmod 600 $HOME/.ssh/id_rsa_deploy
      - ssh-keyscan -H $REMOTE_HOST >> $HOME/.ssh/known_hosts

      # Create target directory
      - ssh -i $HOME/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "mkdir -p $REMOTE_TARGET_PATH/MathBridge-FE/dist"

      # Copy files
      - scp -i $HOME/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no -r ./dist/* $REMOTE_USER@$REMOTE_HOST:$REMOTE_TARGET_PATH/MathBridge-FE/dist/

      # Deploy with PM2
      - |
        ssh -i $HOME/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
          cd $REMOTE_TARGET_PATH/MathBridge-FE &&
          pm2 delete MathBridge_FE || true &&
          pm2 start npx --name MathBridge_FE -- serve -s /root/MathBridge-FE/dist -l 3000 &&
          pm2 save
        "
